apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-create-table
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-postgres
          image: postgres:16
          command: [ 'sh', '-c',
            'until pg_isready -h $DB_HOST -p 5432 -U $DB_USER; do
            echo "Waiting for DB to be ready...";
            sleep 2;
           done;
           echo "DB is ready!"' ]
          env:
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: owner.postgres-cdc-environment.credentials.postgresql.acid.zalan.do
                  key: username
            - name: DB_HOST
              value: postgres-cdc-environment
      containers:
        - name: postgres-client
          image: postgres:13  # or your preferred version
          env:
            - name: PGHOST
              value: postgres-cdc-environment
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: owner.postgres-cdc-environment.credentials.postgresql.acid.zalan.do
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: owner.postgres-cdc-environment.credentials.postgresql.acid.zalan.do
                  key: password
            - name: PGDATABASE
              value: "zalando"
          command: ["psql"]
          args:
            - "-c"
            - |
              CREATE TABLE public.offsets(id TEXT PRIMARY KEY, offset_key TEXT, offset_val TEXT, record_insert_ts  TIMESTAMP NOT NULL, record_insert_seq INTEGER NOT NULL);
              CREATE TABLE public.heartbeat(single_row bool PRIMARY KEY DEFAULT TRUE, last_update TIMESTAMP NOT NULL, CONSTRAINT single_row_check CHECK (single_row));
              CREATE TABLE public.signals (id TEXT NOT NULL PRIMARY KEY, type TEXT NOT NULL, data TEXT);
              CREATE TABLE public.data (id BIGSERIAL PRIMARY KEY, field1 TEXT, field2 TEXT, field3 TEXT);
      restartPolicy: Never
  backoffLimit: 2
